{% macro render_field(df, doc) -%}
	{%- if df.fieldtype=="Table" -%}
		{{ render_table(df, doc) }}
	{%- elif df.fieldtype=="HTML" and df.options -%}
		<div>{{ frappe.render_template(df.options, {"doc": doc}) or "" }}</div>
	{%- elif df.fieldtype in ("Text", "Text Editor", "Code") -%}
		{{ render_text_field(df, doc) }}
	{%- elif df.fieldtype in ("Image", "Attach Image", "Attach")
		and (guess_mimetype(doc[df.fieldname])[0] or "").startswith("image/")  -%}
		{{ render_image(df, doc) }}
	{%- elif df.fieldtype=="Geolocation" -%}
		{{ render_geolocation(df, doc) }}
	{%- elif df.fieldtype=="Signature" -%}
		{{ render_signature(df, doc) }}
	{%- elif df.fieldtype=="Currency" -%}
		{%- if doc.print_templates and doc.print_templates.get(df.fieldname) -%}
			{% include doc.print_templates[df.fieldname] %}
		{%- elif doc.mrp_print_templates and doc.mrp_print_templates.get(df.fieldname) -%}
			{{ frappe.render_template(doc.mrp_print_templates[df.fieldname], {"doc":doc}) }}	
		{%- else -%}
			{{ render_field_with_label(df, doc) }}
		{%- endif -%}
	{%- else -%}
	
		{{ render_field_with_label(df, doc) }}
	
		
	{%- endif -%}
{%- endmacro -%}

{%- macro render_table(df, doc) -%}
	{%- set table_meta = frappe.get_meta(df.options) -%}
	{%- set data = doc.get(df.fieldname)[df.start:df.end] -%}
	{%- if doc.print_templates and doc.print_templates.get(df.fieldname) -%}
		{% include doc.print_templates[df.fieldname] %}
	{%- elif doc.mrp_print_templates and doc.mrp_print_templates.get(df.fieldname) -%}
		{{ frappe.render_template(doc.mrp_print_templates[df.fieldname], {"doc":doc,"table_meta":table_meta,"data":data}) }}		
	{%- else -%}
		{%- if data -%}
		{%- set visible_columns = get_visible_columns(doc.get(df.fieldname),
			table_meta, df) -%}
		<div {{ fieldmeta(df) }}>
			<table class="table table-bordered table-condensed">
				<thead>
					<tr>
						{% if not df.get("hide_sr") or df.hide_sr == None or df.hide_sr == "0" or df.hide_sr == 0 %}
							<th style="width: 30px" class="table-sr">{{ _("Sr") }}</th>
						{% endif %}	
						{% for tdf in visible_columns %}
						{% if ((not data[0].flags.compact_item_print) or tdf.fieldname in doc.get(df.fieldname)[0].flags.compact_item_fields) and (not tdf.get("print_parent") or tdf.print_parent == "" or tdf.print_parent == None) %}
							<th style="width: {{ get_width(tdf) }};" class="{{ get_align_class(tdf) }}" {{ fieldmeta(df) }}>{{print_table_label(tdf,data[0])}}</th>
						{% endif %}
						{% endfor %}
					</tr>
				</thead>
				<tbody>
					{% for d in data %}
					<tr>
						{% if not df.get("hide_sr") or df.hide_sr == None or df.hide_sr == "0" or df.hide_sr == 0 %}
							<td class="table-sr">{{ d.idx }}</td>
						{% endif %}	
						
						{% for tdf in visible_columns %}
						{% if ((not data[0].flags.compact_item_print) or tdf.fieldname in doc.get(df.fieldname)[0].flags.compact_item_fields) and (not tdf.get("print_parent") or tdf.print_parent == "" or tdf.print_parent == None) %}
							<td class="{{ get_align_class(tdf) }}" {{ fieldmeta(df) }}>
							<div class="value">{{ print_value(tdf, d, doc, visible_columns) }}</div></td>
						{% endif %}
						{% endfor %}
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		{%- endif -%}
	{%- endif -%}
{%- endmacro -%}

{% macro fieldmeta(df) -%}
data-fieldname="{{ df.fieldname }}" data-fieldtype="{{ df.fieldtype }}"
{%- endmacro %}

{% macro print_table_label(df,doc) -%}
	{% if (df.print_label)%}
	{{ _(df.print_label) }}
	{%- else -%}
	{{ _(df.label) }}
	{% endif %}

	{% if df.fieldtype == "Currency" %}
	<!-- ({{doc.get_currency(df.fieldname,doc)}}) -->
	{% endif %}
	
{%- endmacro %}

{% macro render_compact_fields_for_parent(df, d, parent_doc, visible_columns) -%}
	{% for tdf in visible_columns %}
		{% if tdf.print_parent == df.fieldname %}
			{% if tdf.print_align == "inline-before" %}
				<span class="pull-left">{% if tdf.print_label  -%}<strong>{{ _(tdf.print_label) }}:</strong>{% endif %}
				{{ print_value(tdf, d, parent_doc) }}</span>
			
			{% endif %}
		{% endif %}
	{% endfor %}

	{{ print_value(df, d, parent_doc) }}
	
	{% for tdf in visible_columns %}
		{% if tdf.print_parent == df.fieldname %}
			{% if tdf.print_align == "inline" %}
				<span>{% if tdf.print_label  -%}<strong>{{ _(tdf.print_label) }}:</strong>{% endif %}
				{{ print_value(tdf, d, parent_doc) }}</span>
			{%- elif tdf.print_align != "inline-before" %}
				<div>{% if tdf.print_label  -%}<strong>{{ _(tdf.print_label) }}:</strong>{% endif %}
				{{ print_value(tdf, d, parent_doc) }}</div>
			{% endif %}
		{% endif %}
	{% endfor %}
	
{%- endmacro %}

{%- macro render_field_with_label(df, doc) -%}
		<div class="row {% if df.bold %}important{% endif %} data-field" {{ fieldmeta(df) }}>
			{% if get_label_location(df) == "hidden"  %}
				<div class="col-xs-{{ "12" if df.fieldtype=="Check" else "12" }}
				{{ get_align_class(df) }} value">
					{% if doc.get(df.fieldname) != None -%}
						{{ print_value(df, doc) }}{% endif %}
				</div>
			{% elif get_label_location(df) =="above" %}
				<div class="print_label col-xs-{{ "12" if df.fieldtype=="Check" else "12" }}
				{%- if doc._align_labels_right %} text-right{%- endif -%}">
				{% if df.fieldtype not in ("Image","HTML","Check") and
					doc.get(df.fieldname) != None %}
				<label>{{ _(df.label) }}</label>
				{% endif %}
				{% if df.fieldtype == "Check" and
				doc.get(df.fieldname) != 0 %}
				<label>{{ _(df.label) }}</label>
				{% endif %}
				</div>
				<div class="col-xs-{{ "12" if df.fieldtype=="Check" else "12" }}
				{{ get_align_class(df) }} value">
					{% if doc.get(df.fieldname) != None -%}
						{{ print_value(df, doc) }}{% endif %}
				</div>
			{% elif get_label_location(df) =="below" %}
				
				<div class="col-xs-{{ "12" if df.fieldtype=="Check" else "12" }}
				{{ get_align_class(df) }} value">
					{% if doc.get(df.fieldname) != None -%}
						{{ print_value(df, doc) }}{% endif %}
				</div>
				<div class="print_label col-xs-{{ "12" if df.fieldtype=="Check" else "12" }}
				{%- if doc._align_labels_right %} text-right{%- endif -%}">


				{% if df.fieldtype not in ("Image", "HTML", "Check") and
					doc.get(df.fieldname) != None %}
				<label>{{ _(df.label) }}</label>
				{% endif %}
				{% if df.fieldtype == "Check" and
				doc.get(df.fieldname) != 0 %}
				<label>{{ _(df.label) }}</label>
				{% endif %}
				</div>
			{% elif get_label_location(df) =="right" %}
			
				
				<div class="col-xs-{{ "3" if df.fieldtype=="Check" else "8" }}
				{{ get_align_class(df) }} value">
					{% if doc.get(df.fieldname) != None -%}
						{{ print_value(df, doc) }}{% endif %}
				</div>
				<div class="print_label col-xs-{{ "9" if df.fieldtype=="Check" else "4" }}
				{%- if doc._align_labels_right %} text-right{%- endif -%}">

				{% if df.fieldtype not in ("Image","HTML","Check") and
					doc.get(df.fieldname) != None %}
				<label>{{ _(df.label) }}</label>
				{% endif %}
				{% if df.fieldtype == "Check" and
				doc.get(df.fieldname) != 0 %}
				<label>{{ _(df.label) }}</label>
				{% endif %}
				</div>
			{% else -%}
			
				<div class="print_label col-xs-{{ "9" if df.fieldtype=="Check" else "4" }}
				{%- if doc._align_labels_right %} text-right{%- endif -%}">

				{% if df.fieldtype not in ("Image","HTML","Check") and
					doc.get(df.fieldname) != None %}
				<label>{{ _(df.label) }}</label>
				{% endif %}
				{% if df.fieldtype == "Check" and
				doc.get(df.fieldname) != 0 %}
				<label>{{ _(df.label) }}</label>
				{% endif %}
				</div>
				<div class="col-xs-{{ "3" if df.fieldtype=="Check" else "8" }}
				{{ get_align_class(df) }} value">
					{% if doc.get(df.fieldname) != None -%}
						{{ _(print_value(df, doc)) }}{% endif %}
				</div>
			{% endif %}
			

		</div>
{%- endmacro -%}

{%- macro render_text_field(df, doc) -%}
{%- if doc.get(df.fieldname) != None -%}
<div style="padding: 10px 0px" {{ fieldmeta(df) }}>
	{%- if df.fieldtype in ("Text", "Code") %}<label>{{ _(df.label) }}</label>{%- endif %}
	{%- if df.fieldtype=="Code" %}
		<pre class="value">{{ doc.get(df.fieldname) }}</pre>
	{% else -%}
		{%- if df.fieldtype=="Text Editor" -%}<div class='text-editor-print'>{%- endif -%}
		{{ doc.get_formatted(df.fieldname, parent_doc or doc, translated=df.translatable) }}
		{%- if df.fieldtype=="Text Editor" -%}</div>{%- endif -%}
  {% endif -%}
</div>
{%- endif -%}
{%- endmacro -%}

{%- macro render_image(df, doc) -%}
	{{ print_value(df, doc) }}
{% endmacro %}

{%- macro render_signature(df, doc) -%}
	{{ print_value(df, doc) }}
{% endmacro %}

{%- macro render_geolocation(df, doc) -%}
	{{ "" }}
{%- endmacro -%}

{%- macro print_value(df, doc, parent_doc=None, visible_columns=None) -%}
	
	
	{% if doc.print_templates and doc.print_templates.get(df.fieldname) %}
        {% include doc.print_templates[df.fieldname] %}
	
	{% elif parent_doc and parent_doc.mrp_print_templates and parent_doc.mrp_print_templates.get(df.fieldname) %}
		{{ frappe.render_template(parent_doc.mrp_print_templates[df.fieldname], {"doc":doc}) }}	
	
	{% elif doc and doc.mrp_print_templates and doc.mrp_print_templates.get(df.fieldname)%}
	
		{{ frappe.render_template(doc.mrp_print_templates[df.fieldname], {"doc":doc}) }}	
		
	{% elif visible_columns %}
		{{  render_compact_fields_for_parent(df, doc, parent_doc, visible_columns) }}
	
	{% elif df.fieldtype=="Check" %}
		<i class="{{ 'fa fa-check' if doc[df.fieldname] }}"></i>
	{% elif df.fieldtype=="Image" %}
		<img src="{{ doc[doc.meta.get_field(df.fieldname).options] }}"
			class="img-responsive"
			{%- if df.print_width %} style="width: {{ get_width(df) }};"{% endif %}>
	{% elif df.fieldtype=="Signature" %}
		<img src="{{ doc[df.fieldname] }}" class="signature-img img-responsive"
			{%- if df.print_width %} style="width: {{ get_width(df) }};"{% endif %}>
	{% elif df.fieldtype in ("Attach", "Attach Image") and doc[df.fieldname]
		and frappe.utils.is_image(doc[df.fieldname]) %}
		<img src="{{ doc[df.fieldname] }}" class="img-responsive"
			{%- if df.print_width %} style="width: {{ get_width(df) }};"{% endif %}>
    {% elif df.fieldtype=="HTML" %}
        {{ frappe.render_template(df.options, {"doc":doc}) }}
	{% else %}
		{% if df.fieldtype=="Currency" %}
			{{ doc.get_formatted(df.fieldname, doc, translated=True) }}
		{% elif df.fieldtype =="Link" and  df.options =="Project" %}
			{{ doc.get_formatted(df.fieldname, parent_doc or doc, translated=True)|replace("AMLS - ", "") }}
		{% else %}
			{{ doc.get_formatted(df.fieldname, parent_doc or doc, translated=df.translatable) }}
		{% endif %}
	{% endif %}
{%- endmacro %}

{% macro get_width(df) -%}
	{%- if df.print_width -%}	
		{%- if "%" in (df.print_width|str) -%}
			{{ ((df.print_width|str).replace("%", "")|trim) }}%
		{%- else -%}
			{{ ((df.print_width|str).replace("px", "")|trim) }}px
		{% endif -%}
	{%- elif df.fieldtype in ("Int", "Check", "Float", "Currency") -%}{{ 80 }}px
	{%- else -%}{{ 150 }}px{% endif -%}
{%- endmacro %}

{% macro get_align_class(df) %}
	{%- if df.align -%}{{ "text-" + df.align }}
	{%- elif df.fieldtype in ("Int", "Float", "Currency", "Check", "Percent") -%}{{ "text-right" }}
	{%- else -%}{{ "" }}
	{%- endif -%}
{% endmacro %}

{% macro get_label_location(df) %}
	{%- if df.label_location -%}{{ df.label_location  }}
	{%- else -%}{{ "left" }}
	{%- endif -%}
{% endmacro %}

{% macro get_label_align_class(df) %}
	{%- if df.label_align -%}{{ "text-" + df.align }}
	{%- else -%}{{ "" }}
	{%- endif -%}
{% endmacro %}

{% macro print_date(doc) -%}
	{%- if doc.transaction_date -%}{{ doc.get_formatted("transaction_date", doc) }}
	{%- elif doc.posting_date -%} {{ doc.get_formatted("posting_date", doc) }}
	{% endif -%}
{%- endmacro %}

{% macro print_heading_template(doc) -%}
	
	
	{% if doc.print_heading_template %}
        {{ frappe.render_template(doc.print_heading_template, {"doc":doc}) }}
    {% else %}
    <div class="print-heading">
		<h2>{{ doc.select_print_heading or (doc.print_heading if doc.print_heading != None
			else _(doc.doctype)) }}<br>
				<small>{{ doc.name }}</small>

        </h2>
    </div>
	{% endif %}

{%- endmacro %}


{% macro get_main_prefix(doc) -%}
	{% set am_prefix = doc.amended_from %}
	{% if frappe.db.get_value(doc.doctype, doc.amended_from, "amended_from") %}
		{% set am_prefix = "-".join(doc.amended_from.split("-")[:-1]) %}
	{% endif %}
	{{am_prefix}}
{%- endmacro %}

{%- macro add_header(page_num, max_pages, doc, letter_head, no_letterhead, footer, print_settings=None) -%}
	
	<div class="letter-head">
	{% if letter_head and not no_letterhead %}
		{{ letter_head }}
	{% endif %}
	</div>
   
	{% if doc.meta.is_submittable and doc.amended_from %}
		{%- set new_doc_name = doc -%}
		{% set test = new_doc_name.update({'name': get_main_prefix(new_doc_name)}) %}
		{{ print_heading_template(new_doc_name) }}
    {% else %}
		{{ print_heading_template(doc) }}
	{% endif %}

	
	
	
	{%- if doc.meta.is_submittable and doc.docstatus==0 and (print_settings==None or print_settings.add_draft_heading) -%}
	<div class="text-center document-status" document-status="draft">
		<h4 style="margin: 0px;">{{ _("DRAFT") }}</h4>
    </div>
	{%- endif -%}
	{%- if doc.meta.is_submittable and doc.docstatus==2-%}
	<div class="text-center" document-status="cancelled">
		<h4 style="margin: 0px;">{{ _("CANCELLED") }}</h4>
    </div>
	{%- endif -%}
{%- endmacro -%}


{%- macro add_footer(max_pages,doc,no_letterhead,footer,signature_html,print_settings=None) -%}
	<div id="footer-html" class="hidden-pdf">
			<div class="letter-head-footer">

	{{ signature_html }}
	
	{% if print_settings.repeat_header_footer %}
		
			{% if not no_letterhead and footer %}

			{{ footer }}

			{% endif %}
			
			{% if not no_letterhead %}

			

			{% endif %}
			
	<!-- {% else %}
	 <div id="variables" style="display: none;"><span id="margin-bottom">25mm</span></div> -->
	{% endif %}
	</div>
	<!-- <p class="text-right small page-number visible-pdf">
			{{ _("{0} of {1}").format('<span class="page"></span>', '<span class="topage"></span>') }}
			</p> -->
	
	</div>
{%- endmacro -%}

